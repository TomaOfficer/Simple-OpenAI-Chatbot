<!doctype html>
<html>
<head>
	<title>Simple OpenAI Chatbot with Custom Knowledge</title>
  <script src="https://replit.com/public/js/repl-auth-v2.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/2.3.3/purify.min.js"></script>
</head>
  <body>
    <div id="chat-container">
      <div id="chat-messages">
          <!-- Chat messages will be dynamically added here -->
      </div>
      <div id="input-area">
          <input type="text" id="user-message" placeholder="Type your message here">
          <button onclick="sendMessage()">Send</button>
      </div>
    </div>

    <script>
      function sendMessage() {
          const userMessage = document.getElementById('user-message').value;
          if (userMessage.trim() === '') return;

          // Add user message to chat
          addMessageToChat('user', userMessage);

          // Clear input field
          document.getElementById('user-message').value = '';

          // Send message to server and get response
          fetch('/chat', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json'
              },
              body: JSON.stringify({ message: userMessage })
          })
          .then(response => response.json())
          .then(data => {
              // Add assistant's response to chat
              addMessageToChat('assistant', data.response);
          })
          .catch(error => console.error('Error:', error));
      }

      function addMessageToChat(sender, message) {
          const chatMessages = document.getElementById('chat-messages');
          const messageElement = document.createElement('div');
          messageElement.className = `message ${sender}-message`;

          if (sender === 'assistant') {
              // Parse markdown and sanitize HTML for assistant messages
              const parsedMessage = marked.parse(message);
              const sanitizedMessage = DOMPurify.sanitize(parsedMessage);
              messageElement.innerHTML = sanitizedMessage;
          } else {
              // For user messages, just use text content
              messageElement.textContent = message;
          }
        
          chatMessages.appendChild(messageElement);

          // Scroll to the bottom of the chat
          chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      // Allow sending message with Enter key
      document.getElementById('user-message').addEventListener('keypress', function(e) {
          if (e.key === 'Enter') {
              sendMessage();
          }
      });
    </script>
  </body>
</html>